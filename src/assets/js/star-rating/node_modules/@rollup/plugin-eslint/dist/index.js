'use strict';

var path = require('path');
var pluginutils = require('@rollup/pluginutils');
var eslint$1 = require('eslint');

function _interopNamespace(e) {
    if (e && e.__esModule) return e;
    var n = Object.create(null);
    if (e) {
        Object.keys(e).forEach(function (k) {
            if (k !== 'default') {
                var d = Object.getOwnPropertyDescriptor(e, k);
                Object.defineProperty(n, k, d.get ? d : {
                    enumerable: true,
                    get: function () { return e[k]; }
                });
            }
        });
    }
    n["default"] = e;
    return Object.freeze(n);
}

var path__namespace = /*#__PURE__*/_interopNamespace(path);

function normalizePath(id) {
    return path__namespace.relative(process.cwd(), id).split(path__namespace.sep).join('/');
}
function eslint(options = {}) {
    if (typeof options === 'string') {
        const configFile = path__namespace.resolve(process.cwd(), options);
        // eslint-disable-next-line global-require, import/no-dynamic-require, no-param-reassign
        options = require(configFile);
        // Tell eslint not to look for configuration files.
        // eslint-disable-next-line no-param-reassign
        options.useEslintrc = false;
    }
    const cli = new eslint$1.CLIEngine(options);
    let formatter;
    switch (typeof options.formatter) {
        case 'string':
            formatter = cli.getFormatter(options.formatter);
            break;
        case 'function':
            ({ formatter } = options);
            break;
        default:
            formatter = cli.getFormatter('stylish');
    }
    const filter = pluginutils.createFilter(options.include, options.exclude || /node_modules/);
    return {
        name: 'eslint',
        // eslint-disable-next-line consistent-return
        transform(code, id) {
            const file = normalizePath(id);
            if (!filter(id) || cli.isPathIgnored(file)) {
                return null;
            }
            const report = cli.executeOnText(code, file);
            const hasWarnings = options.throwOnWarning && report.warningCount !== 0;
            const hasErrors = options.throwOnError && report.errorCount !== 0;
            if (options.fix && report) {
                eslint$1.CLIEngine.outputFixes(report);
            }
            if (report.warningCount === 0 && report.errorCount === 0) {
                return null;
            }
            const result = formatter(report.results);
            if (result) {
                // eslint-disable-next-line no-console
                console.log(result);
            }
            if (hasWarnings && hasErrors) {
                throw Error('Warnings or errors were found');
            }
            if (hasWarnings) {
                throw Error('Warnings were found');
            }
            if (hasErrors) {
                throw Error('Errors were found');
            }
        }
    };
}

module.exports = eslint;
